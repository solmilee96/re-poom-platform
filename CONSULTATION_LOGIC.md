# 상담 답변 로직 (추가 상담 채팅)

이 문서는 **추가 상담** 단계에서 사용자 메시지에 따라 답변을 생성하는 규칙을 정의합니다.  
아이 기질·양육자 성향을 바탕으로 하되, **질문에 맞게 유연하게** 답하고, **같은 문장이 반복되지 않도록** 합니다.

---

## 1. 입력과 상태

- **입력**
  - `question`: 사용자가 입력한 문장 (trim 후 `q`로 사용)
  - `recentHistory`: 최근 대화 배열 (user/assistant 메시지)
- **상태 (매 메시지마다 계산)**
  - `childScores`, `parentScores`: 기질/양육자 문항 점수
  - `temperamentType`, `parentType`: 기질 유형, 양육자 유형
  - `name`, `age`: 아이 이름, 나이(문자열)
  - `lowAdaptability`: 적응성 낮음 (childScores[3] < 5)
  - `highActivity`: 활동성 높음 (childScores[0] > 7)
  - `highSensitivity`: 감각 민감도 높음 (childScores[8] > 7)
  - `lastAssistant`, `lastAssistantText`: 직전 assistant 메시지
  - `isFollowUp`: recentHistory.length >= 2

---

## 2. 분기 순서 (우선 적용)

아래 순서대로 조건을 확인하고, **먼저 맞는 분기에서만** 답변을 반환합니다.

### 2.1 피드백/반박 처리 (우선)

- **패턴**: `틀려|아니에요|다른데|맞지\s*않|안\s*맞|4단계|단계.*틀|그게\s*아니`
- **의도**: “제가 말한 내용이 맞지 않다”는 사용자 피드백
- **응답**:  
  - 맞지 않는 부분이 무엇인지, 또는 **지금 가장 힘든 구체적 상황**(떼쓰기/잠/밥/옷 입기/또래 등)을 한 가지만 적어 달라고 요청.  
  - 그에 맞춰 다시 답하겠다고 안내.

### 2.2 이어지는 질문 (follow-up)

- **조건**: `isFollowUp && lastAssistantText` 존재
- **의도**: 직전 답변과 같은 주제를 이어서 묻는 경우
- 세부 분기:
  - 직전이 **식사/밥** 관련이고, 현재 문장에 `야채|채소|편식|먹기 싫어|안 먹어|그래도 안|해도 안` → 식사 후속 답변 (감각/적응/일반)
  - 직전이 **수면/잠** 관련이고, 현재에 `잠|수면|자기|취침|그래도 안|해도 안` → 수면 후속 (규칙성 높음/낮음)
  - 직전이 **떼/울음** 관련이고, 현재에 `떼|울|짜증|그래도|해도 안` → 떼쓰기 후속 (적응 느림/아님)
  - `얼마나|몇 주|몇 달|언제쯤|기간|지켜봐` → 기질별 기대 기간 (2~4주 / 4~6주 등)
  - `구체적|예시|어떻게 해요|방법|실제로|해보고` → 직전 내용이 적응/감각이면 1·2·3단계 등 구체 방법
  - `왜|이유|원인|그런 행동|그렇게 돼` → 기질별 이유 설명 + “버릇이 아니라 기질/나이” 안심
  - `다른|더|추가|또 있|이외` → 아이·엄마 유형별 추가 팁

### 2.3 주제별 첫 질문 (키워드 매칭)

아래는 **직전 맥락과 무관하게** 현재 문장 `q`만 보고 적용하는 주제 분기입니다.

- **떼/울/짜증**:  
  - 적응 느림 → 예고·선택권·감정 인정 3가지 + “일관되게”  
  - 그 외 → 피곤함·배고픔·자극·변화 점검 제안 + “어떤 상황에서 자주 그런지” 묻기
- **잠/수면/자기/취침/잠투정**:  
  - 규칙성 높음/낮음에 따라 “같은 시간·순서” vs “순서만 매일 동일” 강조, 추천 루틴 4줄
- **밥/식사/먹/편식/밥거부/야채/채소**:  
  - 야채/채소/편식이면: 감각 예민 → 한 가지·퓨레·만져보기·냄새; 적응 느림 → 15~20번 노출·옆에만; 그 외 → 선택권·밥 위에 올리기·엄마가 맛있게 먹는 모습  
  - 전반 식사: 감각 예민 / 적응 느림 / 그 외(발달 단계·선택권·식사 시간 초점)
- **옷/입기/거부/옷입/옷감/태그/입히**:  
  - 감각 예민 → 촉감·태그·압박감 설명, 태그 제거·2~3벌 중 선택  
  - 적응 느림 → 순서·변화 민감, 예고·매일 같은 순서·선택권  
  - 그 외 → 자율성 단계, “이거 vs 저거” 선택·“엄마가 도와줄까 네가 할까”
- **때리/공격/밀/싸움/친구 때**:  
  - 활동성 높음 → 에너지 발산·대근육 놀이·대체 행동  
  - 반응 강도 높음 → “화났구나” 인정 + 말로 표현하기  
  - 그 외 → 나이에 따른 이해 한계 + “때리면 아파, 손은 이렇게” 일관 반복

### 2.4 기본 답변 (fallback)

- **원칙**:  
  - “지금 겪고 계신 상황을 이렇게 이해하시면 좋아요”로 시작하는 **동일한 긴 문단을 반복하지 않는다**.  
  - **맥락에 따라** 다음 중 하나로 구분한다.
- **직전 답변이 이미 “일반 이해 + 2~3주 추천” 유형인 경우**  
  (예: 직전 assistant에 `지금 겪고 계신 상황을 이렇게 이해하시면 좋아요` 또는 `활동성이 높아 에너지 발산이 필요해요` 포함)  
  → **다시 같은 설명을 하지 말고**,  
  “지금 가장 힘든 게 어떤 상황인가요? 예: 떼쓰기, 잠, 밥, 옷 입기, 또래 관계처럼 **한 가지만** 구체적으로 적어 주시면 그걸로 맞춰서 말씀드릴게요. 💕” 형태로 **구체적 상황을 요청**.
- **그 외**  
  → 기질 유형별로 **한두 문장**만 다르게 하고, 공통으로 “**어떤 상황이 가장 힘드신지** 한 가지만 적어 주시면 그걸로 구체적으로 말씀드릴게요”로 끝낸다.  
  - 예: 에너자이저 → “에너지가 많은 [이름]이에겐 예고와 선택권이 특히 도움이 돼요.”  
  - 신중파 → “새로운 걸 천천히 받아들이는 [이름]이에겐 미리 예고하고 순서를 맞춰 주시면 좋아요.”  
  - 섬세파 → “감각이 예민한 [이름]이에겐 자극을 줄이고 선택권을 주는 게 도움이 돼요.”  
  - 탐험가 → “움직임이 많은 [이름]이에겐 짧은 단위로 예고하고, 끝나면 뛰어놀 시간을 주시면 좋아요.”  
  - 순둥이/밸런서/혼합형 → “지금 나이에 맞는 한 가지 방법을 2~3주 해 보시고, 어떤 상황이 힘드신지 알려 주시면 그다음도 이어서 말씀드릴게요.”

---

## 3. 금지 사항

- **동일한 fallback 문단을 연속으로 사용하지 않는다.**  
  특히 “지금 겪고 계신 상황을 이렇게 이해하시면 좋아요: · 활동성이 높아 … · 적응이 느려 … · 감각이 예민해 … 2~3주 꾸준히 … 예고, 선택권 주기, 감정 인정 …” 는 **한 번만** 쓰고, 다음에는 반드시 “구체적 상황 한 가지를 적어 주세요” 유도로 전환.
- **질문과 무관한 긴 설명을 반복하지 않는다.**  
  사용자가 “틀려요”, “4단계라고 했는데도 틀려요” 등으로 피드백을 주면, 같은 내용을 다시 쓰지 말고 **어디가 다른지/어떤 상황인지**를 묻는 짧은 답으로 이어가기.

---

## 4. 적용 위치

- `docs/index.html` 내 `generateResponse` 함수
- `web/public/gwaenchanayo.html` 내 `generateResponse` 함수  

두 파일은 **동일한 로직**을 유지하고, 수정 시 이 문서와 함께 갱신합니다.
